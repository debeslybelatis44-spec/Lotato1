const SpecialGames = {
    generateBOBets(amount) {
        const bets = [];
        for (let i = 0; i < 100; i++) {
            const num = i.toString().padStart(2, '0');
            if (num[0] === num[1]) {
                bets.push({
                    id: Date.now() + Math.random(),
                    game: 'borlette',
                    number: num,
                    cleanNumber: num,
                    amount: amount,
                    drawId: APP_STATE.selectedDraw,
                    timestamp: new Date().toISOString(),
                    isAutoGenerated: true,
                    specialType: 'BO'
                });
            }
        }
        return bets;
    },

    generateNBets(digit, amount) {
        const bets = [];
        for (let i = 0; i < 100; i++) {
            const num = i.toString().padStart(2, '0');
            if (num[1] === digit.toString()) {
                bets.push({
                    id: Date.now() + Math.random(),
                    game: 'borlette',
                    number: num,
                    cleanNumber: num,
                    amount: amount,
                    drawId: APP_STATE.selectedDraw,
                    timestamp: new Date().toISOString(),
                    isAutoGenerated: true,
                    specialType: `N${digit}`
                });
            }
        }
        return bets;
    },

    generateGRAPBets(amount) {
        const bets = [];
        for (let i = 0; i < 10; i++) {
            const num = i.toString().repeat(3);
            bets.push({
                id: Date.now() + Math.random(),
                game: 'lotto3',
                number: num,
                cleanNumber: num,
                amount: amount,
                drawId: APP_STATE.selectedDraw,
                timestamp: new Date().toISOString(),
                isAutoGenerated: true,
                specialType: 'GRAP'
            });
        }
        return bets;
    }
};

const GameEngine = {
    validateEntry(type, num) {
        const cleanNum = num.toString().replace(/[-&]/g, '');
        const n = cleanNum;
        
        switch(type) {
            case 'borlette': return n.length === 2;
            case 'lotto3':   return n.length === 3;
            case 'lotto4':   return n.length === 4;
            case 'lotto5':   return n.length === 5;
            case 'mariage':  return n.length === 4;
            case 'auto_marriage': return true;
            case 'auto_lotto4': return true;
            case 'auto_lotto5': return true;
            case 'bo': return true;
            case 'grap': return true;
            default: 
                if (type.startsWith('n')) return true;
                return false;
        }
    },

    getCleanNumber(num) {
        return num.toString().replace(/[-&]/g, '');
    },

    generateAutoMarriageBets(amount) {
        const borletteNumbers = APP_STATE.currentCart
            .filter(item => item.game === 'borlette' && this.getCleanNumber(item.number).length === 2)
            .map(item => this.getCleanNumber(item.number));

        const uniqueNumbers = [...new Set(borletteNumbers)];
        const autoBets = [];
        
        for (let i = 0; i < uniqueNumbers.length; i++) {
            for (let j = i + 1; j < uniqueNumbers.length; j++) {
                autoBets.push({
                    id: Date.now() + Math.random(),
                    game: 'auto_marriage',
                    number: uniqueNumbers[i] + '&' + uniqueNumbers[j],
                    cleanNumber: uniqueNumbers[i] + uniqueNumbers[j],
                    amount: amount,
                    drawId: APP_STATE.selectedDraw,
                    timestamp: new Date().toISOString(),
                    isAutoGenerated: true
                });
            }
        }
        
        return autoBets;
    },

    generateAutoLotto4Bets(amount) {
        const borletteNumbers = APP_STATE.currentCart
            .filter(item => item.game === 'borlette' && this.getCleanNumber(item.number).length === 2)
            .map(item => this.getCleanNumber(item.number));

        const uniqueNumbers = [...new Set(borletteNumbers)];
        const autoBets = [];
        
        for (let i = 0; i < uniqueNumbers.length; i++) {
            for (let j = 0; j < uniqueNumbers.length; j++) {
                if (i !== j) {
                    autoBets.push({
                        id: Date.now() + Math.random(),
                        game: 'auto_lotto4',
                        number: uniqueNumbers[i] + '-' + uniqueNumbers[j],
                        cleanNumber: uniqueNumbers[i] + uniqueNumbers[j],
                        amount: amount,
                        drawId: APP_STATE.selectedDraw,
                        timestamp: new Date().toISOString(),
                        isAutoGenerated: true
                    });
                }
            }
        }
        
        return autoBets;
    },

    generateAutoLotto5Bets(amount) {
        const lotto3Numbers = APP_STATE.currentCart
            .filter(item => item.game === 'lotto3' && this.getCleanNumber(item.number).length === 3)
            .map(item => this.getCleanNumber(item.number));

        const uniqueNumbers = [...new Set(lotto3Numbers)];
        const autoBets = [];
        
        for (let i = 0; i < uniqueNumbers.length; i++) {
            for (let j = 0; j < uniqueNumbers.length; j++) {
                if (i !== j) {
                    autoBets.push({
                        id: Date.now() + Math.random(),
                        game: 'auto_lotto5',
                        number: uniqueNumbers[i] + '-' + uniqueNumbers[j].slice(-2),
                        cleanNumber: uniqueNumbers[i] + uniqueNumbers[j].slice(-2),
                        amount: amount,
                        drawId: APP_STATE.selectedDraw,
                        timestamp: new Date().toISOString(),
                        isAutoGenerated: true
                    });
                }
            }
        }
        
        return autoBets;
    },
    
    generateLottoBetsWithOptions(gameType, num, amount) {
        const bets = [];
        const cleanNum = this.getCleanNumber(num);
        let options = [];
        
        if (gameType === 'lotto4') {
            options = APP_STATE.lotto4Options;
        } else if (gameType === 'lotto5') {
            options = APP_STATE.lotto5Options;
        } else {
            return bets;
        }
        
        for (let i = 0; i < options.length; i++) {
            if (options[i]) {
                let displayNum = cleanNum;
                if (gameType === 'lotto4' && cleanNum.length === 4) {
                    displayNum = cleanNum.slice(0, 2) + '-' + cleanNum.slice(2, 4);
                } else if (gameType === 'lotto5' && cleanNum.length === 5) {
                    displayNum = cleanNum.slice(0, 3) + '-' + cleanNum.slice(3, 5);
                }
                
                bets.push({
                    id: Date.now() + Math.random(),
                    game: gameType,
                    number: displayNum,
                    cleanNumber: cleanNum,
                    amount: amount,
                    drawId: APP_STATE.selectedDraw,
                    timestamp: new Date().toISOString(),
                    isAutoGenerated: false,
                    option: i + 1
                });
            }
        }
        
        return bets;
    }
};

function setupInputAutoMove() {
    const numInput = document.getElementById('num-input');
    const amtInput = document.getElementById('amt-input');
    
    numInput.addEventListener('input', function(e) {
        const game = APP_STATE.selectedGame;
        let maxLength = 5;
        
        switch(game) {
            case 'borlette': maxLength = 2; break;
            case 'lotto3': maxLength = 3; break;
            case 'lotto4': maxLength = 4; break;
            case 'lotto5': maxLength = 5; break;
            case 'mariage': maxLength = 4; break;
            case 'auto_marriage': maxLength = 0; break;
            case 'auto_lotto4': maxLength = 0; break;
            case 'auto_lotto5': maxLength = 0; break;
            case 'bo': maxLength = 0; break;
            case 'grap': maxLength = 0; break;
        }
        
        if (game.startsWith('n')) {
            maxLength = 0;
        }
        
        if (this.value.length >= maxLength && maxLength > 0) {
            amtInput.focus();
            amtInput.select();
        }
        
        if (game === 'lotto4' && this.value.length === 4) {
            this.value = this.value.replace(/(\d{2})(\d{2})/, '$1-$2');
        } else if (game === 'lotto5' && this.value.length === 5) {
            this.value = this.value.replace(/(\d{3})(\d{2})/, '$1-$2');
        } else if (game === 'mariage' && this.value.length === 4) {
            this.value = this.value.replace(/(\d{2})(\d{2})/, '$1&$2');
        }
    });
    
    amtInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            CartManager.addBet();
        }
    });
}

function toggleNumericChips() {
    APP_STATE.showNumericChips = !APP_STATE.showNumericChips;
    const container = document.getElementById('numeric-chips');
    const btn = document.getElementById('toggle-nx-btn');
    
    if (APP_STATE.showNumericChips) {
        container.classList.add('visible');
        btn.classList.add('active');
        btn.innerHTML = '<i class="fas fa-times"></i> NX';
    } else {
        container.classList.remove('visible');
        btn.classList.remove('active');
        btn.innerHTML = 'NX';
    }
    
    APP_STATE.showLottoGames = false;
    APP_STATE.showSpecialGames = false;
    document.getElementById('lotto-games').classList.remove('visible');
    document.getElementById('special-games').classList.remove('visible');
    
    document.querySelectorAll('#game-types .chip').forEach(chip => {
        chip.classList.remove('active');
    });
    document.querySelector('#game-types .chip[data-game="borlette"]').classList.add('active');
}

function toggleLottoOption(gameType, optionIndex) {
    if (gameType === 4) {
        APP_STATE.lotto4Options[optionIndex - 1] = !APP_STATE.lotto4Options[optionIndex - 1];
    } else if (gameType === 5) {
        APP_STATE.lotto5Options[optionIndex - 1] = !APP_STATE.lotto5Options[optionIndex - 1];
    }
    
    const optionChip = document.querySelector(`#lotto${gameType}-options .option-chip[data-option="${optionIndex}"]`);
    if (optionChip) {
        optionChip.classList.toggle('active');
        optionChip.classList.add('animate-bounce');
        setTimeout(() => {
            optionChip.classList.remove('animate-bounce');
        }, 500);
    }
}

function selectGame(game) {
    if (APP_STATE.isDrawBlocked) {
        alert("Tiraj sa a ap rantre nan 3 minit. Ou pa ka ajoute plis paray.");
        return;
    }
    
    APP_STATE.selectedGame = game;
    const input = document.getElementById('num-input');
    
    document.querySelectorAll('.chip').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.sub-game-btn').forEach(b => b.classList.remove('active'));
    
    if (game.startsWith('n')) {
        document.querySelector(`.numeric-chip[data-game="${game}"]`).classList.add('active');
    }
    
    document.querySelector('#game-types .chip[data-game="borlette"]').classList.add('active');
    
    const placeholderMap = {
        'borlette': '00',
        'lotto3': '000',
        'lotto4': '0000',
        'lotto5': '00000',
        'mariage': '0000',
        'auto_marriage': 'Auto',
        'auto_lotto4': 'Auto',
        'auto_lotto5': 'Auto',
        'bo': 'Auto',
        'grap': 'Auto'
    };
    
    input.placeholder = placeholderMap[game] || '00';
    
    if (game.includes('auto') || game === 'bo' || game === 'grap' || game.startsWith('n')) {
        input.disabled = true;
        input.value = '';
        input.placeholder = 'Auto-genere';
    } else {
        input.disabled = false;
        input.focus();
    }
    
    const lotto4Options = document.getElementById('lotto4-options');
    const lotto5Options = document.getElementById('lotto5-options');
    
    if (game === 'lotto4' || game === 'auto_lotto4') {
        lotto4Options.classList.add('visible');
        lotto5Options.classList.remove('visible');
    } else if (game === 'lotto5' || game === 'auto_lotto5') {
        lotto5Options.classList.add('visible');
        lotto4Options.classList.remove('visible');
    } else {
        lotto4Options.classList.remove('visible');
        lotto5Options.classList.remove('visible');
    }
}

function updateGameSelector() {
    const gameSelector = document.getElementById('game-types');
    gameSelector.innerHTML = `
        <button class="chip active" data-game="borlette" onclick="selectMainGame('borlette')">Borlette</button>
        <button class="chip" data-game="lotto" onclick="selectMainGame('lotto')">Lotto</button>
        <button class="chip" data-game="special" onclick="selectMainGame('special')">Jeux Sp√©ciaux</button>
        <button class="chip" id="toggle-nx-btn" onclick="toggleNumericChips()">NX</button>
    `;
    
    document.querySelectorAll('.sub-game-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const game = this.getAttribute('onclick').match(/selectGame\('(\w+)'\)/)[1];
            selectGame(game);
            this.classList.add('active');
        });
    });
    
    selectGame('borlette');
}

function selectMainGame(game) {
    APP_STATE.showNumericChips = false;
    document.getElementById('numeric-chips').classList.remove('visible');
    document.getElementById('toggle-nx-btn').classList.remove('active');
    document.getElementById('toggle-nx-btn').innerHTML = 'NX';
    
    document.querySelectorAll('#game-types .chip').forEach(chip => {
        chip.classList.remove('active');
    });
    document.querySelector(`#game-types .chip[data-game="${game}"]`).classList.add('active');
    
    if (game === 'lotto') {
        APP_STATE.showLottoGames = !APP_STATE.showLottoGames;
        APP_STATE.showSpecialGames = false;
        
        if (APP_STATE.showLottoGames) {
            document.getElementById('lotto-games').classList.add('visible');
            document.getElementById('special-games').classList.remove('visible');
        } else {
            document.getElementById('lotto-games').classList.remove('visible');
        }
    } else if (game === 'special') {
        APP_STATE.showSpecialGames = !APP_STATE.showSpecialGames;
        APP_STATE.showLottoGames = false;
        
        if (APP_STATE.showSpecialGames) {
            document.getElementById('special-games').classList.add('visible');
            document.getElementById('lotto-games').classList.remove('visible');
        } else {
            document.getElementById('special-games').classList.remove('visible');
        }
    } else if (game === 'borlette') {
        APP_STATE.showLottoGames = false;
        APP_STATE.showSpecialGames = false;
        document.getElementById('lotto-games').classList.remove('visible');
        document.getElementById('special-games').classList.remove('visible');
        selectGame('borlette');
    }
}